version: 2.1

executors:
  frontend:
    docker:
      - image: cimg/node:14.17.6
        environment:
          REACT_APP_URL: http://127.0.0.1
          REACT_APP_PORT: 5000
  backend:
    docker:
      - image: cimg/node:14.17.6
        environment:
          database_test: phantom_test
          user_test: postgres
          password_test: password
          host_test: localhost
          port: 5432
          ssl: 0
          jwtSecret: pern
      - image: circleci/postgres:13.4
        auth:
          username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: phantom_test

commands: 
  server-packages:
    steps:
      - run:
          name: Install yarn server packages
          command: |
            cd ~/project/server
            yarn install
  client-packages:
    steps:
      - run: 
          name: Install yarn client packages
          command: |
            cd ~/project/client
            yarn install
  pretest-migrations_seeds:
    steps:
      - run:
          name: Run pretest migrations and seeds
          command: |
            cd ~/project/server
            yarn run pretest
    
jobs:
  frontend_lint:
    executor: frontend
    steps:
      - checkout
      - client-packages
      - run:
          name: Run ESlint (Frontend)
          command: |
            cd ~/project/client
            yarn run lint
  backend_lint:
    executor: backend
    steps:
      - checkout
      - server-packages
      - run:
          name: Run ESlint (Backend)
          command: |
            cd ~/project/server
            yarn run lint
  frontend_tests:
    executor: frontend
    steps:
      - checkout
      - client-packages
      - run:
          name: Run tests
          command: |
            cd ~/project/client
            yarn test
  backend_tests:
    executor: backend
    steps:
      - checkout
      - server-packages
      - run:
          name: Run tests
          command: |
            cd ~/project/server
            yarn test
  
  newman-collection-run:
    executor: backend
    steps:
      - checkout
      - server-packages
      - pretest-migrations_seeds
      - run:
          name: Run newman collection
          command: |
            cd ~/project/server
            sudo yarn global add newman
            (NODE_ENV=test yarn start&)
            NODE_ENV=test newman run postman/order_details.postman_collection\ .json 

workflows: 
  version: 2.1
  build: 
    jobs: 
      - frontend_lint
      - backend_lint
      - frontend_tests
      - backend_tests
      - newman-collection-run
